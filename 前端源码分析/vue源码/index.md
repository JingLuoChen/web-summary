# Vue 源码解析

组件渲染过程 --- template -> ast -> render -> vDom -> 真实的Dom -> 页面


##一、Vue的定义

Vue 实际上就是一个用 Function 实现的类， 我们只能通过 new vue 去实例化它

并且通过很多的xxxMixin的函数调用，把 Vue 当参数传入，这些函数的功能都是给 Vue 的原型链prototype上扩展一些方法 

Vue 按功能把这些扩展分散到多个模块中去实现 而不是在一个模块中实现所有 这种方式是用 Class 难以实现的


initGlobalAPI

Vue 在整个初始化过程中 除了给它的原型prototype上扩展方法，还会给 Vue 这个对象本身扩展全局的静态方法 例如 util方法 set方法 等等 就是在 Vue 上扩展一些全局方法的定义

总结 本质上就是一个用 Function 实现的 Class 然后它的原型prototype以及它本身都扩展了一系列的方法和属性

-----------------------------------------------------------------------------------------------------------------------------------------------------------------

## 二、数据驱动

Vue 一个核心的思想就是 数据驱动

所谓数据驱动 是指视图是由数据驱动生成的 我们对视图的修改 不会直接操作DOM 而是通过修改数据来改变视图

-----------------------------------------------------------------------------------------------------------------------------------------------------------------

## 三、new Vue 发生了什么

Vue 实际上是一个类 类在js中是用Function来实现的 即 Vue 只能通过 new 关键字初始化 然后会调用 this._init 方法 

Vue 初始化主要就是干了几件事 --- 合并配置 初始化生命周期 初始化事件中心 初始化渲染 初始化data props computed watcher

初始化的最后 检测到如果有 el 属性 则调用 vm.$mount 方法挂载vm 挂载的目标就是把模板渲染成最终的DOM 

-----------------------------------------------------------------------------------------------------------------------------------------------------------------

## 四、Vue 实例挂载的实现

$mount 方法

首先 它对 el 做了限制 Vue 不能挂载在 body html 这样的根节点上

如果没有定义 render 方法 则会把 el 或者 template 字符串转换成 render 方法 

在 Vue2.0 版本中 所有 Vue的组件的渲染最终都需要 render 方法 

无论 我们是 用单文件 .vue 方式开发组件 还是写了 el 或者 template 属性 最终都会转换成 render 方法

这样就可以被 runtime only 版本的 Vue 直接使用 


$mount 方法支持传人2个参数 

第一个是 el 它表示挂载的元素 可以是字符串 也可以是 DOM 对象

如果是字符串在浏览器环境下会调用 query 方法 转换成 DOM 对象的

第二个参数是和服务端渲染相关 在浏览器环境下我们不需要传第二个参数


$mount 方法 实际上会调用 mountComponent 方法  

mountComponent 核心就是先调用 vm.render 方法先生成虚拟Node 再实例化一个渲染watcher 在它的回调函数中会调用 updateComponent 方法 最终调用 vm._update 更新 DOM


watcher 在这里起到两个作用 --- 其实就是 监控数据是否发生变化 及时更新 DOM

一个是初始化的时候会执行回调函数

一个是当 vm 实例中的监测的数据发生变化的时候执行回调函数

-----------------------------------------------------------------------------------------------------------------------------------------------------------------

## 五、render 

Vue 的 _render 方法是实例的一个私有方法 它用来把实例渲染成一个虚拟Node 

vm._render 最终是通过执行 createElement 方法并返回的是 vnode 它是一个虚拟Node 

-----------------------------------------------------------------------------------------------------------------------------------------------------------------

## 六、Virtual DOM 

从本质上来说 VD只是一个简单的js对象 并且最少包含tag props 和 children 三个属性 --- 标签名 属性 子元素对象 

VD 跟 DOM 对象有一一对应的关系

VD的最大特点是将页面的状态抽象为JS对象的形式 配合不同的渲染工具 使跨平台渲染成为可能 

在进行页面更新的时候 借助VD DOM元素的改变可以在内存中进行比较 在结合框架的事务机制将多次比较的结果合并后 一次性 更新到页面

从而有效的减少页面渲染的次数 提高渲染效率


页面会分成三个阶段 

JS计算 生成渲染树 绘制页面


Virtual DOM就是用一个原生的JS对象去描述一个DOM节点 即 比创建一个DOM的代价要小很多 

在Vue.js中 Virtual DOM是用 VNode 这么一个 Class 去描述

-----------------------------------------------------------------------------------------------------------------------------------------------------------------

## 七、createElement

Vue.js 利用 createElement 方法创建 VNode 

createElement 方法实际上是对 _createElement 方法的封装 它允许传入的参数更加灵活 在处理这些参数后 调用真正创建VNode的函数 _createElement

_createElement 5个参数

context 表示 VNode 的上下问环境 它是 component 类型

tag 表示 标签 它可以是一个字符串 也可以是一个 component 

data 表示 VNode 的数据  它是一个 VNodeData 类型 

children 表示 当前 VNode 的子节点 它是任意类型的 需要被规范为标准的 VNode 数组

normalizationType 表示 子节点规范的类型 类型不同规范的方法也就不一样

-----------------------------------------------------------------------------------------------------------------------------------------------------------------

## 八、children 的规范化

由于 Virtual DOM 实际上是一个树状结构 每一个 VNode 可能会有若干个子节点 这些子节点应该也是VNode的类型

根据 normalizationType 的不同 调用了 normalizeChildren(children) 和 simpleNormalizeChildren(children)

children 变成一个类型为 VNode 的 Array

-----------------------------------------------------------------------------------------------------------------------------------------------------------------

## 九、VNode的创建

这里 先对 tag 做判断 

如果是 string 类型 则接着判断 

    如果是内置的一些节点 则直接创建一个普通的 VNode 

    如果是为已注册的组件名 则通过 createComponent 创建一个组件类型的 VNode 否则 创建一个未知的标签的 VNode 

    如果是一个 Component 类型 则直接调用 createComponent 创建一个组件类型的 VNode 节点

-----------------------------------------------------------------------------------------------------------------------------------------------------------------

## 十、update

Vue 的 _update 是实例的一个私有方法

_update 

调用的时机 ---  一个是首次渲染 一个是数据更新 

作用 --- 把 VNode 渲染成真实的 DOM

核心 --- 调用 vm.__patch__ 方法 

-----------------------------------------------------------------------------------------------------------------------------------------------------------------

## 总结 初始化 Vue 到最终渲染的整个过程

new Vue -> init -> $mount -> compile -> render -> vnode -> patch -> DOM 
